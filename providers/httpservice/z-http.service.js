"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var z_http_error_reply_1 = require("./z-http-error-reply");
var z_http_error_1 = require("./z-http-error");
var z_util_1 = require("../../utils/z.util");
var z_http_reply_default_1 = require("./z-http-reply-default");
var z_log_util_1 = require("../../utils/z-log.util");
var ZHttpService = (function () {
    function ZHttpService() {
    }
    ZHttpService.prototype.get = function (url, zOption, result) {
        zOption = zOption || {};
        zOption.type = 'GET';
        zOption.url = url || zOption.url;
        zOption.result = result || zOption.result;
        return this.request(zOption);
    };
    ZHttpService.prototype.post = function (url, zOption, result) {
        zOption = zOption || {};
        zOption.type = 'POST';
        zOption.url = url || zOption.url;
        zOption.result = result || zOption.result;
        return this.request(zOption);
    };
    ZHttpService.prototype.getMultiRequest = function (requestMulti) {
        if (requestMulti.option && requestMulti.option.length > 0) {
            requestMulti.option.forEach(function (value) { return value.type = 'GET'; });
        }
        return this.requestMulti(requestMulti);
    };
    ZHttpService.prototype.postMultiRequest = function (requestMulti) {
        if (requestMulti.option && requestMulti.option.length > 0) {
            requestMulti.option.forEach(function (value) { return value.type = 'POST'; });
        }
        return this.requestMulti(requestMulti);
    };
    ZHttpService.prototype.requestMulti = function (multiRequestOption) {
        var obArray = [];
        multiRequestOption = multiRequestOption || {};
        if (!multiRequestOption.isHideLoading) {
            wx.showLoading({
                title: multiRequestOption.loadingMsg || '',
            });
        }
        if (multiRequestOption.option && multiRequestOption.option.length > 0) {
            for (var _i = 0, _a = multiRequestOption.option; _i < _a.length; _i++) {
                var request = _a[_i];
                request.result = request.result || {};
                obArray.push(this.requestObservable(request));
            }
        }
        return Promise.all(obArray)
            .then(function (obj) {
            wx.hideLoading({});
            for (var i = 0; i < obj.length; i++) {
                var item = obj[i];
                if (multiRequestOption.option[i] && multiRequestOption.option[i].result) {
                    if (multiRequestOption.option[i].result.success) {
                        multiRequestOption.option[i].result.success(item);
                    }
                    if (multiRequestOption.option[i].result.complete) {
                        multiRequestOption.option[i].result.complete();
                    }
                }
            }
        })
            .catch(function (error) {
            wx.hideLoading({});
            for (var i = 0; i < multiRequestOption.option.length; i++) {
                if (multiRequestOption.option[i] && multiRequestOption.option[i].result) {
                    if (multiRequestOption.option[i].result.error) {
                        multiRequestOption.option[i].result.error(error);
                    }
                    if (multiRequestOption.option[i].result.complete) {
                        multiRequestOption.option[i].result.complete();
                    }
                }
            }
        });
    };
    ZHttpService.prototype.request = function (zOption) {
        var _this = this;
        zOption.result = zOption.result || {};
        if (!zOption.isHideLoading) {
            wx.showLoading({
                title: zOption.loadingMsg || '',
            });
        }
        return this.requestObservable(zOption)
            .then(function (resolve, reject) { return _this.successResult(zOption.result); })
            .catch(this.errorResult(zOption.result));
    };
    ZHttpService.prototype.requestObservable = function (zOption) {
        var _this = this;
        zOption.type = zOption.type || 'POST';
        zOption.header = this.processHeader(zOption.header);
        zOption.zreply = zOption.zreply || new z_http_reply_default_1.ZHttpReplyDefault();
        z_log_util_1.ZLogUtil.log("\n===================================================================");
        z_log_util_1.ZLogUtil.log("ADDR:" + zOption.url);
        z_log_util_1.ZLogUtil.log(zOption.body ? "APPLY:" + JSON.stringify(zOption.body) : "");
        return new Promise(function (resolve, reject) {
            var requestTask = wx.request({
                url: zOption.url || '',
                data: zOption.body,
                header: zOption.header,
                method: zOption.type,
                success: function (res) {
                    _this.processResponse(zOption.zreply, res, zOption.isHideLoading);
                },
                fail: function (error) {
                    _this.processCatch(zOption.isHideToastError, error);
                }
            });
            resolve(requestTask);
        });
    };
    ZHttpService.prototype.processHeader = function (header) {
        if (!header) {
            header = {};
        }
        header['Content-Type'] = 'application/x-www-form-urlencoded; charset=UTF-8';
        return header;
    };
    ZHttpService.prototype.processResponse = function (zreply, res, isHideLoading, resolve, reject) {
        var jsonObj = res;
        z_log_util_1.ZLogUtil.log("===================================================================");
        z_log_util_1.ZLogUtil.log("REPLY:" + JSON.stringify(jsonObj));
        if (zreply) {
            if (zreply.isSuccess(jsonObj[zreply.codeKey])) {
                if (jsonObj[zreply.dataKey]) {
                    resolve(jsonObj[zreply.dataKey]);
                }
                else {
                    resolve(jsonObj);
                }
                return;
            }
            if (!zreply.isSuccess(jsonObj[zreply.codeKey]) && (jsonObj[zreply.codeKey] || jsonObj[zreply.msgKey])) {
                reject(this.processCatch(isHideLoading, new z_http_error_1.ZHttpError(jsonObj.code, jsonObj.msg)));
            }
            else {
                reject(this.processCatch(isHideLoading, new z_http_error_1.ZHttpError(1001, "数据不符合规范：\n" + JSON.stringify(res))));
            }
        }
    };
    ZHttpService.prototype.processCatch = function (isHideToastError, error) {
        var errorObj;
        if (error instanceof z_http_error_1.ZHttpError || (z_util_1.ZUtil.isValid(error.code) && z_util_1.ZUtil.isValid(error.errMsg))) {
            errorObj = this.getErrorReply(error.errMsg, error.code);
        }
        else {
            errorObj = this.getErrorReply(error.errMsg, -1);
        }
        if (!isHideToastError) {
            var msg = z_util_1.ZUtil.isValid(errorObj.code) ? errorObj.msg + "(" + errorObj.code + ")" : errorObj.msg;
            wx.showToast({
                title: msg || '',
            });
        }
        return errorObj;
    };
    ZHttpService.prototype.getErrorReply = function (message, code) {
        var errorObj = new z_http_error_reply_1.ZHttpErrorReply();
        errorObj.code = code;
        errorObj.msg = (message == null) ? "null" : message;
        return errorObj;
    };
    ZHttpService.prototype.successResult = function (result) {
        return function (obj) {
            wx.hideLoading({});
            if (result.success) {
                result.success(obj);
            }
            if (result.complete) {
                result.complete();
            }
        };
    };
    ZHttpService.prototype.errorResult = function (result) {
        return function (error) {
            wx.hideLoading({});
            if (result.error) {
                result.error(error);
            }
            if (result.complete) {
                result.complete();
            }
        };
    };
    return ZHttpService;
}());
exports.ZHttpService = ZHttpService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiei1odHRwLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ6LWh0dHAuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUdBLDJEQUFxRDtBQUdyRCwrQ0FBMEM7QUFDMUMsNkNBQXlDO0FBQ3pDLCtEQUF5RDtBQUd6RCxxREFBZ0Q7QUFHaEQ7SUFBQTtJQW9SQSxDQUFDO0lBM1FVLDBCQUFHLEdBQVYsVUFBYyxHQUFXLEVBQUUsT0FBdUIsRUFBRSxNQUFzQjtRQUN0RSxPQUFPLEdBQUcsT0FBTyxJQUFJLEVBQUUsQ0FBQztRQUN4QixPQUFPLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQztRQUNyQixPQUFPLENBQUMsR0FBRyxHQUFHLEdBQUcsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDO1FBQ2pDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsTUFBTSxJQUFJLE9BQU8sQ0FBQyxNQUFNLENBQUM7UUFDMUMsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFTTSwyQkFBSSxHQUFYLFVBQWUsR0FBVyxFQUFFLE9BQXVCLEVBQUUsTUFBc0I7UUFDdkUsT0FBTyxHQUFHLE9BQU8sSUFBSSxFQUFFLENBQUM7UUFDeEIsT0FBTyxDQUFDLElBQUksR0FBRyxNQUFNLENBQUM7UUFDdEIsT0FBTyxDQUFDLEdBQUcsR0FBRyxHQUFHLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQztRQUNqQyxPQUFPLENBQUMsTUFBTSxHQUFHLE1BQU0sSUFBSSxPQUFPLENBQUMsTUFBTSxDQUFDO1FBQzFDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBT00sc0NBQWUsR0FBdEIsVUFBdUIsWUFBcUM7UUFDeEQsSUFBSSxZQUFZLENBQUMsTUFBTSxJQUFJLFlBQVksQ0FBQyxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUN2RCxZQUFZLENBQUMsTUFBTSxD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Q0FBYSxHQUFyQixVQUFzQixPQUFlLEVBQUUsSUFBYTtRQUNoRCxJQUFJLFFBQVEsR0FBRyxJQUFJLG9DQUFlLEVBQUUsQ0FBQztRQUNyQyxRQUFRLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNyQixRQUFRLENBQUMsR0FBRyxHQUFHLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztRQUNwRCxPQUFPLFFBQVEsQ0FBQztJQUNwQixDQUFDO0lBT08sb0NBQWEsR0FBckIsVUFBeUIsTUFBc0I7UUFDM0MsT0FBTyxVQUFDLEdBQVE7WUFDWixFQUFFLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ25CLElBQUksTUFBTSxDQUFDLE9BQU8sRUFBRTtnQkFDaEIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUN2QjtZQUVELElBQUksTUFBTSxDQUFDLFFBQVEsRUFBRTtnQkFDakIsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDO2FBQ3JCO1FBRUwsQ0FBQyxDQUFDO0lBQ04sQ0FBQztJQU9PLGtDQUFXLEdBQW5CLFVBQXVCLE1BQXNCO1FBQ3pDLE9BQU8sVUFBQyxLQUFVO1lBQ2QsRUFBRSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUNuQixJQUFJLE1BQU0sQ0FBQyxLQUFLLEVBQUU7Z0JBQ2QsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUN2QjtZQUVELElBQUksTUFBTSxDQUFDLFFBQVEsRUFBRTtnQkFDakIsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDO2FBQ3JCO1FBQ0wsQ0FBQyxDQUFDO0lBQ04sQ0FBQztJQUNMLG1CQUFDO0FBQUQsQ0FBQyxBQXBSRCxJQW9SQztBQXBSWSxvQ0FBWSIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogaHR0cCDmnI3liqHnsbtcbiAqL1xuaW1wb3J0IHtaSHR0cEVycm9yUmVwbHl9IGZyb20gXCIuL3otaHR0cC1lcnJvci1yZXBseVwiO1xuaW1wb3J0IHtaSHR0cFJlc3VsdH0gZnJvbSBcIi4vei1odHRwLXJlc3VsdFwiO1xuaW1wb3J0IHtaSHR0cE9wdGlvbn0gZnJvbSAnLi96LWh0dHAtb3B0aW9uJztcbmltcG9ydCB7Wkh0dHBFcnJvcn0gZnJvbSAnLi96LWh0dHAtZXJyb3InO1xuaW1wb3J0IHtaVXRpbH0gZnJvbSBcIi4uLy4uL3V0aWxzL3oudXRpbFwiO1xuaW1wb3J0IHtaSHR0cFJlcGx5RGVmYXVsdH0gZnJvbSBcIi4vei1odHRwLXJlcGx5LWRlZmF1bHRcIjtcbmltcG9ydCB7Wkh0dHBSZXBseX0gZnJvbSBcIi4vei1odHRwLXJlcGx5XCI7XG5pbXBvcnQge1pIdHRwTXVsdGlSZXF1ZXN0T3B0aW9ufSBmcm9tIFwiLi96LWh0dHAtbXVsdGktcmVxdWVzdC1vcHRpb25cIjtcbmltcG9ydCB7WkxvZ1V0aWx9IGZyb20gXCIuLi8uLi91dGlscy96LWxvZy51dGlsXCI7XG5pbXBvcnQgUmVxdWVzdFRhc2sgPSB3eC5SZXF1ZXN0VGFzaztcblxuZXhwb3J0IGNsYXNzIFpIdHRwU2VydmljZSB7XG5cbiAgICAvKipcbiAgICAgKiBnZXTor7fmsYIo5LyY5YWI5L2/55SodXJs77yMcmVzdWx05Y+C5pWw77yM5aaC5p6c5LiN6K6+572u77yM5YiZ5L2/55Soek9wdGlvbuS4reeahHVybO+8jHJlc3VsdCwg5aaC5p6cek9wdGlvbuS4uuepuu+8jOWImeaWsOW7unpPcHRpb24pXG4gICAgICpcbiAgICAgKiBAcGFyYW0gdXJsICAgICAgICAgICAgICAgICAgIOivt+axguWcsOWdgFxuICAgICAqIEBwYXJhbSB6T3B0aW9uICAgICAgICAgICAgICAg6K+35rGC5Y+C5pWwIHtAbGluayBaSHR0cEVycm9yfVxuICAgICAqIEBwYXJhbSByZXN1bHQgICAgICAgICAgICAgICAg5Zue6LCD5o6l5Y+jIHtAbGluayBaSHR0cFJlc3VsdH1cbiAgICAgKi9cbiAgICBwdWJsaWMgZ2V0PFQ+KHVybDogc3RyaW5nLCB6T3B0aW9uOiBaSHR0cE9wdGlvbjxUPiwgcmVzdWx0OiBaSHR0cFJlc3VsdDxUPik6IFByb21pc2U8YW55PiB7XG4gICAgICAgIHpPcHRpb24gPSB6T3B0aW9uIHx8IHt9O1xuICAgICAgICB6T3B0aW9uLnR5cGUgPSAnR0VUJztcbiAgICAgICAgek9wdGlvbi51cmwgPSB1cmwgfHwgek9wdGlvbi51cmw7XG4gICAgICAgIHpPcHRpb24ucmVzdWx0ID0gcmVzdWx0IHx8IHpPcHRpb24ucmVzdWx0O1xuICAgICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KHpPcHRpb24pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIHBvc3Tor7fmsYIo5LyY5YWI5L2/55SodXJs77yMcmVzdWx05Y+C5pWw77yM5aaC5p6c5LiN6K6+572u77yM5YiZ5L2/55Soek9wdGlvbuS4reeahHVybO+8jHJlc3VsdCwg5aaC5p6cek9wdGlvbuS4uuepuu+8jOWImeaWsOW7unpPcHRpb24pXG4gICAgICpcbiAgICAgKiBAcGFyYW0gdXJsICAgICAgICAgICAgICAgICAgIOivt+axguWcsOWdgFxuICAgICAqIEBwYXJhbSB6T3B0aW9uICAgICAgICAgICAgICAg6K+35rGC5Y+C5pWwIHtAbGluayBaSHR0cEVycm9yfVxuICAgICAqIEBwYXJhbSByZXN1bHQgICAgICAgICAgICAgICAg5Zue6LCD5o6l5Y+jIHtAbGluayBaSHR0cFJlc3VsdH1cbiAgICAgKi9cbiAgICBwdWJsaWMgcG9zdDxUPih1cmw6IHN0cmluZywgek9wdGlvbjogWkh0dHBPcHRpb248VD4sIHJlc3VsdDogWkh0dHBSZXN1bHQ8VD4pOiBQcm9taXNlPGFueT4ge1xuICAgICAgICB6T3B0aW9uID0gek9wdGlvbiB8fCB7fTtcbiAgICAgICAgek9wdGlvbi50eXBlID0gJ1BPU1QnO1xuICAgICAgICB6T3B0aW9uLnVybCA9IHVybCB8fCB6T3B0aW9uLnVybDtcbiAgICAgICAgek9wdGlvbi5yZXN1bHQgPSByZXN1bHQgfHwgek9wdGlvbi5yZXN1bHQ7XG4gICAgICAgIHJldHVybiB0aGlzLnJlcXVlc3Qoek9wdGlvbik7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5ZCM5pe25Y+R6LW35aSa5LiqR2V06K+35rGC77yMIOaMieiHquWumuS5ieWbnuiwg+aWueazlei/m+ihjOWbnuiwg++8jOWbnuiwg+mhuuW6j+aMieWPkei1t+mhuuW6j+OAguacieS4gOS4quaOpeWPo+Wksei0pe+8jOWImeaJgOacieivt+axguWksei0peOAglxuICAgICAqIEBwYXJhbSB7Wkh0dHBNdWx0aVJlcXVlc3RPcHRpb25bXX0gcmVxdWVzdE11bHRpXG4gICAgICogQHJldHVybnMge1Byb21pc2V9XG4gICAgICovXG4gICAgcHVibGljIGdldE11bHRpUmVxdWVzdChyZXF1ZXN0TXVsdGk6IFpIdHRwTXVsdGlSZXF1ZXN0T3B0aW9uKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgaWYgKHJlcXVlc3RNdWx0aS5vcHRpb24gJiYgcmVxdWVzdE11bHRpLm9wdGlvbi5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICByZXF1ZXN0TXVsdGkub3B0aW9uLmZvckVhY2goKHZhbHVlOiBhbnkpID0+IHZhbHVlLnR5cGUgPSAnR0VUJyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMucmVxdWVzdE11bHRpKHJlcXVlc3RNdWx0aSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5ZCM5pe25Y+R6LW35aSa5LiqUG9zdOivt+axgu+8jCDlt7LmjInoh6rlrprkuYnlm57osIPmlrnms5Xov5vooYzlm57osIPvvIzlm57osIPmlbDmja7mnKrmlbDnu4TvvIzlm57osIPpobrluo/mjInlj5Hotbfpobrluo9cbiAgICAgKiBAcGFyYW0ge1pIdHRwTXVsdGlSZXF1ZXN0T3B0aW9ufSByZXF1ZXN0TXVsdGlcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICAgKi9cbiAgICBwdWJsaWMgcG9zdE11bHRpUmVxdWVzdChyZXF1ZXN0TXVsdGk6IFpIdHRwTXVsdGlSZXF1ZXN0T3B0aW9uKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgaWYgKHJlcXVlc3RNdWx0aS5vcHRpb24gJiYgcmVxdWVzdE11bHRpLm9wdGlvbi5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICByZXF1ZXN0TXVsdGkub3B0aW9uLmZvckVhY2goKHZhbHVlOiBhbnkpID0+IHZhbHVlLnR5cGUgPSAnUE9TVCcpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLnJlcXVlc3RNdWx0aShyZXF1ZXN0TXVsdGkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOWQjOaXtuWPkei1t+WkmuS4que9kee7nOivt+axgu+8jCDlt7LmjInoh6rlrprkuYnlm57osIPmlrnms5Xov5vooYzlm57osIPvvIzlm57osIPmlbDmja7mnKrmlbDnu4TvvIzlm57osIPpobrluo/mjInlj5Hotbfpobrluo9cbiAgICAgKiBAcGFyYW0ge1pIdHRwTXVsdGlSZXF1ZXN0T3B0aW9uW119IG11bHRpUmVxdWVzdE9wdGlvblxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlfVxuICAgICAqL1xuICAgIHB1YmxpYyByZXF1ZXN0TXVsdGkobXVsdGlSZXF1ZXN0T3B0aW9uOiBaSHR0cE11bHRpUmVxdWVzdE9wdGlvbik6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGxldCBvYkFycmF5ID0gW107XG4gICAgICAgIG11bHRpUmVxdWVzdE9wdGlvbiA9IG11bHRpUmVxdWVzdE9wdGlvbiB8fCB7fTtcbiAgICAgICAgaWYgKCFtdWx0aVJlcXVlc3RPcHRpb24uaXNIaWRlTG9hZGluZykge1xuICAgICAgICAgICAgd3guc2hvd0xvYWRpbmcoe1xuICAgICAgICAgICAgICAgIHRpdGxlOiBtdWx0aVJlcXVlc3RPcHRpb24ubG9hZGluZ01zZyB8fCAnJyxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG11bHRpUmVxdWVzdE9wdGlvbi5vcHRpb24gJiYgbXVsdGlSZXF1ZXN0T3B0aW9uLm9wdGlvbi5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBmb3IgKGxldCByZXF1ZXN0IG9mIG11bHRpUmVxdWVzdE9wdGlvbi5vcHRpb24pIHtcbiAgICAgICAgICAgICAgICByZXF1ZXN0LnJlc3VsdCA9IHJlcXVlc3QucmVzdWx0IHx8IHt9O1xuICAgICAgICAgICAgICAgIG9iQXJyYXkucHVzaCh0aGlzLnJlcXVlc3RPYnNlcnZhYmxlKHJlcXVlc3QpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChvYkFycmF5KVxuICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChvYmo6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICB3eC5oaWRlTG9hZGluZyh7fSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb2JqLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgaXRlbSA9IG9ialtpXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtdWx0aVJlcXVlc3RPcHRpb24ub3B0aW9uW2ldICYmIG11bHRpUmVxdWVzdE9wdGlvbi5vcHRpb25baV0ucmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtdWx0aVJlcXVlc3RPcHRpb24ub3B0aW9uW2ldLnJlc3VsdC5zdWNjZXNzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXVsdGlSZXF1ZXN0T3B0aW9uLm9wdGlvbltpXS5yZXN1bHQuc3VjY2VzcyhpdGVtKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG11bHRpUmVxdWVzdE9wdGlvbi5vcHRpb25baV0ucmVzdWx0LmNvbXBsZXRlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXVsdGlSZXF1ZXN0T3B0aW9uLm9wdGlvbltpXS5yZXN1bHQuY29tcGxldGUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyb3I6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd3guaGlkZUxvYWRpbmcoe30pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtdWx0aVJlcXVlc3RPcHRpb24ub3B0aW9uLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG11bHRpUmVxdWVzdE9wdGlvbi5vcHRpb25baV0gJiYgbXVsdGlSZXF1ZXN0T3B0aW9uLm9wdGlvbltpXS5yZXN1bHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobXVsdGlSZXF1ZXN0T3B0aW9uLm9wdGlvbltpXS5yZXN1bHQuZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG11bHRpUmVxdWVzdE9wdGlvbi5vcHRpb25baV0ucmVzdWx0LmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG11bHRpUmVxdWVzdE9wdGlvbi5vcHRpb25baV0ucmVzdWx0LmNvbXBsZXRlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtdWx0aVJlcXVlc3RPcHRpb24ub3B0aW9uW2ldLnJlc3VsdC5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDnvZHnu5zor7fmsYLvvIwg5bey5oyJ6Ieq5a6a5LmJ5Zue6LCD5pa55rOV6L+b6KGM5Zue6LCDXG4gICAgICogQHBhcmFtIHtaSHR0cE9wdGlvbn0gek9wdGlvblxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlfVxuICAgICAqL1xuICAgIHB1YmxpYyByZXF1ZXN0PFQ+KHpPcHRpb246IFpIdHRwT3B0aW9uPFQ+KSB7XG4gICAgICAgIHpPcHRpb24ucmVzdWx0ID0gek9wdGlvbi5yZXN1bHQgfHwge307XG4gICAgICAgIGlmICghek9wdGlvbi5pc0hpZGVMb2FkaW5nKSB7XG4gICAgICAgICAgICB3eC5zaG93TG9hZGluZyh7XG4gICAgICAgICAgICAgICAgdGl0bGU6IHpPcHRpb24ubG9hZGluZ01zZyB8fCAnJyxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLnJlcXVlc3RPYnNlcnZhYmxlKHpPcHRpb24pXG4gICAgICAgICAgICAgICAgICAgLnRoZW4oKHJlc29sdmU6IGFueSwgcmVqZWN0OiBhbnkpID0+IHJldHVybiB0aGlzLnN1Y2Nlc3NSZXN1bHQoek9wdGlvbi5yZXN1bHQpKVxuICAgICAgICAgICAgICAgICAgIC5jYXRjaCh0aGlzLmVycm9yUmVzdWx0KHpPcHRpb24ucmVzdWx0KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog572R57uc6K+35rGC77yM5aSE55CG5a6M5omA5pyJ5Lia5Yqh5pWw5o2u77yM5pyq5oyJ6Ieq5a6a5LmJ5Zue6LCD5pa55rOV5Zue6LCD77yM6L+U5ZueT2JzZXJ2YWJsZe+8jOWPr+S7pei/m+ihjOi/m+S4gOatpeWkhOeQhlxuICAgICAqIEBwYXJhbSB7Wkh0dHBPcHRpb259IHpPcHRpb25cbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZTxUPn1cbiAgICAgKi9cbiAgICBwdWJsaWMgcmVxdWVzdE9ic2VydmFibGU8VD4oek9wdGlvbjogWkh0dHBPcHRpb248VD4pOiBQcm9taXNlPFJlcXVlc3RUYXNrPiB7XG4gICAgICAgIHpPcHRpb24udHlwZSA9IHpPcHRpb24udHlwZSB8fCAnUE9TVCc7XG4gICAgICAgIHpPcHRpb24uaGVhZGVyID0gdGhpcy5wcm9jZXNzSGVhZGVyKHpPcHRpb24uaGVhZGVyKTsgLy/mt7vliqDpgJrnlKhoZWFkZXJcbiAgICAgICAgek9wdGlvbi56cmVwbHkgPSB6T3B0aW9uLnpyZXBseSB8fCBuZXcgWkh0dHBSZXBseURlZmF1bHQoKTtcbiAgICAgICAgWkxvZ1V0aWwubG9nKFwiXFxuPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVwiKTtcbiAgICAgICAgWkxvZ1V0aWwubG9nKFwiQUREUjpcIiArIHpPcHRpb24udXJsKTtcbiAgICAgICAgWkxvZ1V0aWwubG9nKHpPcHRpb24uYm9keSA/IFwiQVBQTFk6XCIgKyBKU09OLnN0cmluZ2lmeSh6T3B0aW9uLmJvZHkpIDogXCJcIik7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZTogYW55LCByZWplY3Q6IGFueSkgPT4ge1xuICAgICAgICAgICAgbGV0IHJlcXVlc3RUYXNrOiBSZXF1ZXN0VGFzayA9IHd4LnJlcXVlc3Qoe1xuICAgICAgICAgICAgICAgIHVybDogek9wdGlvbi51cmwgfHwgJycsXG4gICAgICAgICAgICAgICAgZGF0YTogek9wdGlvbi5ib2R5LFxuICAgICAgICAgICAgICAgIGhlYWRlcjogek9wdGlvbi5oZWFkZXIsXG4gICAgICAgICAgICAgICAgbWV0aG9kOiB6T3B0aW9uLnR5cGUsXG4gICAgICAgICAgICAgICAgc3VjY2VzczogcmVzID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wcm9jZXNzUmVzcG9uc2Uoek9wdGlvbi56cmVwbHksIHJlcywgek9wdGlvbi5pc0hpZGVMb2FkaW5nKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGZhaWw6IGVycm9yID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wcm9jZXNzQ2F0Y2goek9wdGlvbi5pc0hpZGVUb2FzdEVycm9yLCBlcnJvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXNvbHZlKHJlcXVlc3RUYXNrKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog6I635Y+W6buY6K6k55qESGVhZGVy5L+h5oGvXG4gICAgICovXG4gICAgcHVibGljIHByb2Nlc3NIZWFkZXIoaGVhZGVyOiBhbnkpIHtcbiAgICAgICAgaWYgKCFoZWFkZXIpIHtcbiAgICAgICAgICAgIGhlYWRlciA9IHt9O1xuICAgICAgICB9XG5cbiAgICAgICAgaGVhZGVyWydDb250ZW50LVR5cGUnXSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQ7IGNoYXJzZXQ9VVRGLTgnO1xuICAgICAgICAvL2hlYWRlclsnWC1USC1UT0tFTiddPSBVc2VyU2VydmljZS5nZXRUb2tlbigpXG4gICAgICAgIHJldHVybiBoZWFkZXI7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5aSE55CG6L+U5Zue5L+h5oGvXG4gICAgICogQHBhcmFtIHpyZXBseSAgIOiHquWumuS5iee7k+aenOWvueixoVxuICAgICAqIEBwYXJhbSByZXMgICAgICBodHRw5ZON5bqU5a+56LGhXG4gICAgICogQHBhcmFtIGlzSGlkZUxvYWRpbmdcbiAgICAgKiBAcGFyYW0gcmVzb2x2ZVxuICAgICAqIEBwYXJhbSByZWplY3RcbiAgICAgKi9cbiAgICBwdWJsaWMgcHJvY2Vzc1Jlc3BvbnNlKHpyZXBseT86IFpIdHRwUmVwbHksIHJlcz86IGFueSwgaXNIaWRlTG9hZGluZz86IGJvb2xlYW4sIHJlc29sdmU/OiBhbnksIHJlamVjdD86IGFueSkge1xuICAgICAgICBsZXQganNvbk9iaiA9IHJlczsgLy/mraTlpIRqc29uT2Jq5LiA5a6a5pyJ5YC877yM5aaC5p6c6L2s5o2i6ZSZ6K+v77yM5Lya5YaNcHJvY2Vzc0NhdGNo5Lit5aSE55CGXG4gICAgICAgIFpMb2dVdGlsLmxvZyhcIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cIik7XG4gICAgICAgIFpMb2dVdGlsLmxvZyhcIlJFUExZOlwiICsgSlNPTi5zdHJpbmdpZnkoanNvbk9iaikpO1xuXG4gICAgICAgIGlmICh6cmVwbHkpIHtcbiAgICAgICAgICAgIGlmICh6cmVwbHkuaXNTdWNjZXNzKGpzb25PYmpbenJlcGx5LmNvZGVLZXldKSkge1xuICAgICAgICAgICAgICAgIGlmIChqc29uT2JqW3pyZXBseS5kYXRhS2V5XSkge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGpzb25PYmpbenJlcGx5LmRhdGFLZXldKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGpzb25PYmopO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghenJlcGx5LmlzU3VjY2Vzcyhqc29uT2JqW3pyZXBseS5jb2RlS2V5XSkgJiYgKGpzb25PYmpbenJlcGx5LmNvZGVLZXldIHx8IGpzb25PYmpbenJlcGx5Lm1zZ0tleV0pKSB7IC8v5pivanNvbuWvueixoe+8jOS9huaYr+S4jeaYr+e6puWumuS4reeahOaVsOaNrlxuICAgICAgICAgICAgICAgIHJlamVjdCh0aGlzLnByb2Nlc3NDYXRjaChpc0hpZGVMb2FkaW5nLCBuZXcgWkh0dHBFcnJvcihqc29uT2JqLmNvZGUsIGpzb25PYmoubXNnKSkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZWplY3QodGhpcy5wcm9jZXNzQ2F0Y2goaXNIaWRlTG9hZGluZywgbmV3IFpIdHRwRXJyb3IoMTAwMSwgXCLmlbDmja7kuI3nrKblkIjop4TojIPvvJpcXG5cIiArIEpTT04uc3RyaW5naWZ5KHJlcykpKSkgLy/op6PmnpDnmoRqc29u5pWw5o2u5LiN56ym5ZCI6KeE6IyDXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDlpITnkIblvILluLjkv6Hmga9cbiAgICAgKiBAcGFyYW0gaXNIaWRlVG9hc3RFcnJvciAgICAgIOaYr+WQpuaYvuekumVycm9yVG9hc3RcbiAgICAgKiBAcGFyYW0gZXJyb3IgICAgICAgICAgICAgICAgIOmUmeivr+WvueixoVxuICAgICAqL1xuICAgIHB1YmxpYyBwcm9jZXNzQ2F0Y2goaXNIaWRlVG9hc3RFcnJvcj86IGJvb2xlYW4sIGVycm9yPzogYW55KSB7XG4gICAgICAgIGxldCBlcnJvck9iajtcbiAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgWkh0dHBFcnJvciB8fCAoWlV0aWwuaXNWYWxpZChlcnJvci5jb2RlKSAmJiBaVXRpbC5pc1ZhbGlkKGVycm9yLmVyck1zZykpKSB7IC8v6Ieq5bex5a6a5LmJ55qE6ZSZ6K+vIGludGFuY2VvZuWIpOaWreS4jeWHuuadpe+8n1xuICAgICAgICAgICAgZXJyb3JPYmogPSB0aGlzLmdldEVycm9yUmVwbHkoZXJyb3IuZXJyTXNnLCBlcnJvci5jb2RlKTsgLy/mnI3liqHlmajov5Tlm57nmoTplJnor69cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGVycm9yT2JqID0gdGhpcy5nZXRFcnJvclJlcGx5KGVycm9yLmVyck1zZywgLTEpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFpc0hpZGVUb2FzdEVycm9yKSB7XG4gICAgICAgICAgICBsZXQgbXNnID0gWlV0aWwuaXNWYWxpZChlcnJvck9iai5jb2RlKSA/IGVycm9yT2JqLm1zZyArIFwiKFwiICsgZXJyb3JPYmouY29kZSArIFwiKVwiIDogZXJyb3JPYmoubXNnO1xuICAgICAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICAgICAgICB0aXRsZTogbXNnIHx8ICcnLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZXJyb3JPYmo7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog6I635Y+W57uE5ZCIRXJyb3JSZXBseeWvueixoVxuICAgICAqL1xuICAgIHByaXZhdGUgZ2V0RXJyb3JSZXBseShtZXNzYWdlOiBzdHJpbmcsIGNvZGU/OiBudW1iZXIpOiBaSHR0cEVycm9yUmVwbHkge1xuICAgICAgICBsZXQgZXJyb3JPYmogPSBuZXcgWkh0dHBFcnJvclJlcGx5KCk7XG4gICAgICAgIGVycm9yT2JqLmNvZGUgPSBjb2RlOyAvL+iHquWumuS5iemUmeivr+agh+ivhlxuICAgICAgICBlcnJvck9iai5tc2cgPSAobWVzc2FnZSA9PSBudWxsKSA/IFwibnVsbFwiIDogbWVzc2FnZTtcbiAgICAgICAgcmV0dXJuIGVycm9yT2JqO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOWkhOeQhuaIkOWKn+Wbnuiwg1xuICAgICAqIEBwYXJhbSB7Wkh0dHBSZXN1bHQ8VD59IHJlc3VsdFxuICAgICAqIEByZXR1cm5zIHsob2JqKSA9PiB2b2lkfVxuICAgICAqL1xuICAgIHByaXZhdGUgc3VjY2Vzc1Jlc3VsdDxUPihyZXN1bHQ6IFpIdHRwUmVzdWx0PFQ+KTogUHJvbWlzZTxSZXF1ZXN0VGFzaz4ge1xuICAgICAgICByZXR1cm4gKG9iajogYW55KSA9PiB7XG4gICAgICAgICAgICB3eC5oaWRlTG9hZGluZyh7fSk7XG4gICAgICAgICAgICBpZiAocmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQuc3VjY2VzcyhvYmopO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocmVzdWx0LmNvbXBsZXRlKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LmNvbXBsZXRlKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDlpITnkIbplJnor6/lm57osINcbiAgICAgKiBAcGFyYW0ge1pIdHRwUmVzdWx0PFQ+fSByZXN1bHRcbiAgICAgKiBAcmV0dXJucyB7KGVycm9yKSA9PiB2b2lkfVxuICAgICAqL1xuICAgIHByaXZhdGUgZXJyb3JSZXN1bHQ8VD4ocmVzdWx0OiBaSHR0cFJlc3VsdDxUPikge1xuICAgICAgICByZXR1cm4gKGVycm9yOiBhbnkpID0+IHtcbiAgICAgICAgICAgIHd4LmhpZGVMb2FkaW5nKHt9KTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQuZXJyb3IpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocmVzdWx0LmNvbXBsZXRlKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LmNvbXBsZXRlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfVxufSJdfQ==